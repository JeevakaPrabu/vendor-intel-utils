From ebd6f33fec1dc4f448d8b7575d5d57b1dfebc71c Mon Sep 17 00:00:00 2001
From: Jeevaka Prabu Badrappan <jeevaka.badrappan@intel.com>
Date: Thu, 2 Mar 2023 10:03:48 +0530
Subject: [PATCH] Changes to compile codec2.0 in Android 11

Change-Id: I7d3daec43a927c23c77838349698fb5640ea713d
Tracked-On: OAM-108761
Signed-off-by: Jeevaka Prabu Badrappan <jeevaka.badrappan@intel.com>
---
 Android.bp                                    |  2 +-
 .../src/mfx_c2_decoder_component.cpp          | 21 +++++--------------
 c2_store/Android.bp                           |  3 +--
 c2_utils/Android.mk                           |  1 +
 c2_utils/include/mfx_c2_defs.h                |  4 ++--
 5 files changed, 10 insertions(+), 21 deletions(-)

diff --git a/Android.bp b/Android.bp
index 03d58cc..95ae294 100644
--- a/Android.bp
+++ b/Android.bp
@@ -33,7 +33,7 @@ mfx_cc_defaults {
     export_include_dirs: ["include"],
 
     include_dirs: [
-        "hardware/intel/external/minigbm-intel/cros_gralloc", // remove then minigbm gets Android.bp
+        "vendor/intel/external/project-celadon/minigbm/cros_gralloc", // remove then minigbm gets Android.bp
         "frameworks/av/media/libstagefright/foundation/include",
         "frameworks/av/media/bufferpool/2.0/include",
         "frameworks/av/media/codec2/sfplugin/utils",
diff --git a/c2_components/src/mfx_c2_decoder_component.cpp b/c2_components/src/mfx_c2_decoder_component.cpp
index 55b071c..40e1b78 100755
--- a/c2_components/src/mfx_c2_decoder_component.cpp
+++ b/c2_components/src/mfx_c2_decoder_component.cpp
@@ -47,13 +47,6 @@ constexpr uint64_t kDefaultConsumerUsage =
     (GRALLOC_USAGE_HW_TEXTURE | GRALLOC_USAGE_HW_COMPOSER);
 
 
-// Android S declared VP8 profile
-#if MFX_ANDROID_VERSION <= MFX_R
-enum VP8_PROFILE {
-    PROFILE_VP8_0 = C2_PROFILE_LEVEL_VENDOR_START,
-};
-#endif
-
 enum VP8_LEVEL {
     LEVEL_VP8_Version0 = C2_PROFILE_LEVEL_VENDOR_START,
 };
@@ -333,7 +326,7 @@ MfxC2DecoderComponent::MfxC2DecoderComponent(const C2String name, const CreateCo
             break;
         }
         case DECODER_VP9: {
-            m_uOutputDelay = /*max_dpb_size*/9 + /*for async depth*/1 + /*for msdk unref in sync part*/1;
+            m_uOutputDelay = /*max_dpb_size*/16 + /*for async depth*/1 + /*for msdk unref in sync part*/1;
 
             addParameter(
                 DefineParam(m_inputMediaType, C2_PARAMKEY_INPUT_MEDIA_TYPE)
@@ -382,6 +375,7 @@ MfxC2DecoderComponent::MfxC2DecoderComponent(const C2String name, const CreateCo
                 .build());
             break;
         }
+#if MFX_ANDROID_VERSION >= MFX_S
         case DECODER_VP8: {
             m_uOutputDelay = /*max_dpb_size*/8 + /*for async depth*/1 + /*for msdk unref in sync part*/1;
 
@@ -411,17 +405,10 @@ MfxC2DecoderComponent::MfxC2DecoderComponent(const C2String name, const CreateCo
 
             addParameter(DefineParam(m_profileLevel, C2_PARAMKEY_PROFILE_LEVEL)
                 .withDefault(new C2StreamProfileLevelInfo::input(
-#if MFX_ANDROID_VERSION <= MFX_R
-                    SINGLE_STREAM_ID, PROFILE_VP8_0, C2Config::LEVEL_UNUSED))
-                .withFields({
-                    C2F(m_profileLevel, profile).equalTo(
-                        PROFILE_VP8_0),
-#else
                     SINGLE_STREAM_ID, C2Config::profile_t::PROFILE_VP8_0, C2Config::LEVEL_UNUSED))
                 .withFields({
                     C2F(m_profileLevel, profile).equalTo(
                         C2Config::profile_t::PROFILE_VP8_0),
-#endif
                     C2F(m_profileLevel, level).equalTo(
                         C2Config::LEVEL_UNUSED),
                 })
@@ -429,6 +416,7 @@ MfxC2DecoderComponent::MfxC2DecoderComponent(const C2String name, const CreateCo
                 .build());
             break;
         }
+#endif
         case DECODER_MPEG2: {
             m_uOutputDelay = /*max_dpb_size*/4 + /*for async depth*/1 + /*for msdk unref in sync part*/1;
 
@@ -656,9 +644,10 @@ void MfxC2DecoderComponent::RegisterClass(MfxC2ComponentsRegistry& registry)
     registry.RegisterMfxC2Component("c2.intel.vp9.decoder",
         &MfxC2Component::Factory<MfxC2DecoderComponent, DecoderType>::Create<DECODER_VP9>);
 
+#if MFX_ANDROID_VERSION >= MFX_S
     registry.RegisterMfxC2Component("c2.intel.vp8.decoder",
         &MfxC2Component::Factory<MfxC2DecoderComponent, DecoderType>::Create<DECODER_VP8>);
-
+#endif
     registry.RegisterMfxC2Component("c2.intel.mp2.decoder",
         &MfxC2Component::Factory<MfxC2DecoderComponent, DecoderType>::Create<DECODER_MPEG2>);
 
diff --git a/c2_store/Android.bp b/c2_store/Android.bp
index facf00f..4165de0 100644
--- a/c2_store/Android.bp
+++ b/c2_store/Android.bp
@@ -51,8 +51,7 @@ cc_binary {
         "android.hardware.media.omx@1.0",
         "libavservices_minijail_vendor",
         "libbinder",
-        "libhidltransport",
-        "libhwbinder",
+        "libhidlbase",
         "libstagefright_omx",
         "libstagefright_xmlparser",
     ],
diff --git a/c2_utils/Android.mk b/c2_utils/Android.mk
index 8ffaa9d..7b983ba 100644
--- a/c2_utils/Android.mk
+++ b/c2_utils/Android.mk
@@ -44,6 +44,7 @@ LOCAL_C_INCLUDES := \
     system/core/include/utils \
     system/core/base/include \
     $(MFX_C2_INCLUDES) \
+    $(MFX_C2_INCLUDES_LIBVA) \
     $(MFX_C2_HOME)/c2_utils/include \
     $(MFX_C2_HOME)/plugin_store/include
 
diff --git a/c2_utils/include/mfx_c2_defs.h b/c2_utils/include/mfx_c2_defs.h
index 48809da..466120f 100755
--- a/c2_utils/include/mfx_c2_defs.h
+++ b/c2_utils/include/mfx_c2_defs.h
@@ -29,10 +29,10 @@
 #define CREATE_MFX_C2_COMPONENT_FUNC_NAME "MfxCreateC2Component"
 
 #define MFX_C2_CONFIG_FILE_NAME "mfx_c2_store.conf"
-#define MFX_C2_CONFIG_FILE_PATH "/vendor/etc"
+#define MFX_C2_CONFIG_FILE_PATH "/system/vendor/etc"
 
 #define MFX_C2_CONFIG_XML_FILE_NAME "media_codecs_intel_c2_video.xml"
-#define MFX_C2_CONFIG_XML_FILE_PATH "/vendor/etc"
+#define MFX_C2_CONFIG_XML_FILE_PATH "/system/vendor/etc"
 
 #define MFX_C2_DUMP_DIR "/data/local/tmp"
 #define MFX_C2_DUMP_OUTPUT_SUB_DIR "c2-output"
-- 
2.40.0

