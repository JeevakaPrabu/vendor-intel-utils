From 405439d8b576d2c70f0535b9edd562cc704fb3e5 Mon Sep 17 00:00:00 2001
From: Jeevaka Prabu Badrappan <jeevaka.badrappan@intel.com>
Date: Tue, 11 Apr 2023 21:47:51 +0530
Subject: [PATCH] Fix for green overlay during video playback

Gralloc buffer has been aligned with 64 lines whereas the surface is
created with 32 alignment resulting in green overlay.

Fix the issue by modifying the alignment to 64 while calculating
offsets.

Change-Id: I89346107bfa5658230ebb42846dc0651fba31aa4
Tracked-On: OAM-108761
Signed-off-by: Marc Mao <marc.mao@intel.com>
Signed-off-by: Jeevaka Prabu Badrappan <jeevaka.badrappan@intel.com>
---
 omx_utils/src/mfx_omx_vaapi_allocator.cpp | 4 ++--
 1 file changed, 2 insertions(+), 2 deletions(-)

diff --git a/omx_utils/src/mfx_omx_vaapi_allocator.cpp b/omx_utils/src/mfx_omx_vaapi_allocator.cpp
index 43c9417..5fae460 100644
--- a/omx_utils/src/mfx_omx_vaapi_allocator.cpp
+++ b/omx_utils/src/mfx_omx_vaapi_allocator.cpp
@@ -534,10 +534,10 @@ mfxStatus MfxOmxVaapiFrameAllocator::CreateSurfaceFromGralloc(const mfxU8* handl
     surfExtBuf.pitches[2] = 0;
     surfExtBuf.pitches[3] = 0;
     surfExtBuf.offsets[0] = 0;
-    surfExtBuf.offsets[1] = info.pitch * ((height + 31) & ~31); // Gralloc buffer has been aligned with 32 pixels
+    surfExtBuf.offsets[1] = info.pitch * ((height + 63) & ~63);
     surfExtBuf.offsets[2] = 0;
     surfExtBuf.offsets[3] = 0;
-    surfExtBuf.data_size = info.pitch * ((height + 31) & ~31) * 1.5;
+    surfExtBuf.data_size = info.pitch * ((height + 63) & ~63) * 1.5;
     surfExtBuf.num_planes = 2;
     surfExtBuf.num_buffers = 1;
 #ifdef MFX_OMX_USE_PRIME
-- 
2.40.0

